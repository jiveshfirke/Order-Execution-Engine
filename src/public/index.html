<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Execution Engine</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; background: #1a1a1a; color: #00ff00; padding: 20px; max-width: 800px; margin: 0 auto; }
        .container { border: 1px solid #333; padding: 20px; border-radius: 8px; background: #000; }
        button { background: #00ff00; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; font-size: 16px; }
        button:hover { background: #00cc00; }
        #logs { margin-top: 20px; height: 300px; overflow-y: auto; border-top: 1px solid #333; padding-top: 10px; white-space: pre-wrap; }
        .status { color: #888; }
        .highlight { color: #fff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Order Execution Engine</h1>
        <p>System Status: <span id="ws-status" style="color:red">Disconnected</span></p>
        
        <div style="margin: 20px 0;">
            <label>Token Pair: <input type="text" value="SOL-USDC" id="pair" style="padding:5px;"></label>
            <label>Amount: <input type="number" value="10" id="amount" style="padding:5px; width:60px;"></label>
            <button onclick="placeOrder()">EXECUTE ORDER</button>
        </div>

        <h3>Live Execution Logs:</h3>
        <div id="logs">Waiting for orders...</div>
    </div>

    <script>
        const logDiv = document.getElementById('logs');
        const wsStatus = document.getElementById('ws-status');

        function log(msg, type='info') {
            const line = document.createElement('div');
            line.className = type;
            line.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.prepend(line);
        }

        async function placeOrder() {
            const pair = document.getElementById('pair').value;
            const amount = document.getElementById('amount').value;

            log(`Submitting order for ${amount} ${pair}...`, 'highlight');

            try {
                // 1. POST Request
                const res = await fetch('/api/orders/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: Number(amount), tokenPair: pair, type: 'market' })
                });
                
                const data = await res.json();
                if(data.orderId) {
                    log(` Order Queued! ID: ${data.orderId}`, 'highlight');
                    connectWebSocket(data.orderId);
                }
            } catch (err) {
                log(` Error: ${err.message}`, 'error');
            }
        }

        function connectWebSocket(orderId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/orders/${orderId}`;
            const ws = new WebSocket(wsUrl);

            ws.onopen = () => { wsStatus.innerText = 'Connected'; wsStatus.style.color = 'lime'; };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(` STATUS UPDATE: ${data.status.toUpperCase()} ${data.data ? JSON.stringify(data.data) : ''}`);
                
                if(data.status === 'confirmed') log(' TRADE SETTLED SUCCESSFULLY', 'highlight');
                if(data.status === 'failed') log(' TRADE FAILED (Will Retry)', 'highlight');
            };
            ws.onclose = () => { wsStatus.innerText = 'Disconnected'; wsStatus.style.color = 'red'; };
        }
    </script>
</body>
</html>
